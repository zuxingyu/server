include/master-slave.inc
[connection master]
connection slave;
include/stop_slave.inc
connection master;
CALL mtr.add_suppression("Found . prepared XA transactions");
create table t1 (a int primary key) engine=rocksdb;
create table t2 (a int primary key) engine=innodb;
XA START 'xa1';
INSERT INTO t1 VALUES (1);
INSERT INTO t2 VALUES (2);
XA END 'xa1';
SET SESSION DEBUG_DBUG="d,simulate_crash_after_binlog_prepare";
XA PREPARE 'xa1';
ERROR HY000: Lost connection to MySQL server during query
include/rpl_reconnect.inc
"*** xa1 in the list"
XA RECOVER;
formatID	gtrid_length	bqual_length	data
1	3	0	xa1
XA ROLLBACK 'xa1';
SELECT count(*) as zero FROM t1;
zero
0
SELECT count(*) as zero FROM t2;
zero
0
XA START 'xa2';
INSERT INTO t1 VALUES (1);
INSERT INTO t2 VALUES (2);
XA END 'xa2';
XA PREPARE 'xa2';
SET SESSION DEBUG_DBUG="d,simulate_crash_after_binlog_commit_or_rollback";
XA ROLLBACK 'xa2';
ERROR HY000: Lost connection to MySQL server during query
include/rpl_reconnect.inc
"*** empty list"
XA RECOVER;
formatID	gtrid_length	bqual_length	data
SELECT count(*) as zero FROM t1;
zero
0
SELECT count(*) as zero FROM t2;
zero
0
XA START 'xa3';
INSERT INTO t1 VALUES (1);
INSERT INTO t2 VALUES (2);
XA END 'xa3';
XA PREPARE 'xa3';
SET SESSION DEBUG_DBUG="d,simulate_crash_after_binlog_commit_or_rollback";
XA COMMIT 'xa3';
ERROR HY000: Lost connection to MySQL server during query
include/rpl_reconnect.inc
"*** empty list"
XA RECOVER;
formatID	gtrid_length	bqual_length	data
SELECT count(*) as one FROM t1;
one
1
SELECT count(*) as one FROM t2;
one
1
connection slave;
include/start_slave.inc
connection master;
connection slave;
include/diff_tables.inc [master:t1, slave:t1]
include/diff_tables.inc [master:t2, slave:t2]
connection master;
SET SESSION DEBUG_DBUG="";
drop table t1,t2;
connection slave;
include/rpl_end.inc
